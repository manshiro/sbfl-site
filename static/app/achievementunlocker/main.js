const placeholders=["早起き","完全に理解した","積みゲーを崩した","足の小指をタンスの角にぶつけた","バズった","真面目に出社","単位を落とした"],themes=[{value:"twt",name:"鳥っぽいテーマ",backgroundColor:"rgb(29, 161, 242)",inputBackgroundColor:"rgb(29, 120, 200)",titleColor:"rgb(240, 240, 250)",contentColor:"rgb(230, 230, 230)",selected:!0},{value:"stm",name:"蒸気っぽいテーマ",backgroundColor:"rgb(35, 31, 32)",inputBackgroundColor:"rgb(30, 30, 30)",titleColor:"rgb(240, 240, 250)",contentColor:"rgb(180, 180, 180)"},{value:"ntd",name:"京都っぽいテーマ",backgroundColor:"rgb(230, 0, 18)",inputBackgroundColor:"rgb(180, 0, 0)",titleColor:"rgb(240, 240, 250)",contentColor:"rgb(230, 230, 230)"},{value:"sny",name:"記号っぽいテーマ",backgroundColor:"rgb(0, 104, 191)",inputBackgroundColor:"rgb(0, 60, 150)",titleColor:"rgb(240, 240, 250)",contentColor:"rgb(230, 230, 230)"},{value:"mcs",name:"箱っぽいテーマ",backgroundColor:"rgb(16, 124, 16)",inputBackgroundColor:"rgb(0, 60, 0)",titleColor:"rgb(240, 240, 250)",contentColor:"rgb(230, 230, 230)"}],icons=[{value:"padlock",name:"鍵",url:"./img/padlock.svg",selected:!0},{value:"trophy",name:"トロフィー",url:"./img/trophy.svg"}],userInputSessionStoreKey="achievementunlocker/userinput",canvas=document.querySelector(".preview-canvas"),context=canvas.getContext("2d"),userInputData={title:"実績のロックを解除しました！",content:""},userInputSessionInfo=loadJson(userInputSessionStoreKey,!0),dialog=document.querySelector("#dialog"),dialogMessage=dialog.querySelector(".dialog-message"),signinDialog=document.querySelector("#signin-dialog");async function loadImage(e){const t=new Image;return new Promise((n,o)=>{t.onload=(e=>{n(t)}),t.src=e})}function applyUserInputData(e){e.theme&&(document.body.style.setProperty("--theme-background-color",e.theme.backgroundColor),document.body.style.setProperty("--theme-input-background-color",e.theme.inputBackgroundColor),document.body.style.setProperty("--theme-title-color",e.theme.titleColor),document.body.style.setProperty("--theme-content-color",e.theme.contentColor))}function renderPreview(e){const t={title:e.title,content:e.content,iconImage:e.icon,maskNineSlice:e.nineSlice};e.theme&&(t.backgroundColor=e.theme.backgroundColor,t.titleTextColor=e.theme.titleColor,t.contentTextColor=e.theme.contentColor);const n=new AchievementWindow(720,500,t);n.resizeToFitVertical(context),canvas.height=n.height,context.clearRect(0,0,canvas.width,canvas.height),n.render(context)}if(location.search&&storageIsAvailable){const e=new URLSearchParams(location.search),t=loadJson(requestTokenStorageKey,!0).oauth_token_secret;if(sessionStorage.removeItem(requestTokenStorageKey),e.has("oauth_token")&&e.has("oauth_verifier")){dialogMessage.innerText="Twitter認証確認中……",dialog.dataset.visible="true";const n={oauth_token:e.get("oauth_token"),oauth_verifier:e.get("oauth_verifier")};requestTwitterToken("https://api.twitter.com/oauth/access_token",n,{key:t}).then(e=>{const t={oauth_token:e.oauth_token,oauth_token_secret:e.oauth_token_secret};saveJson(accessTokenStorageKey,t,!0),location.href=location.origin+location.pathname}).catch(e=>{console.error(e),alert(e.message),dialog.dataset.visible="false"})}}!async function(){const e=getCurrentAuthInfo(),t=document.querySelector(".theme-select");for(const e of themes){const n=document.createElement("option");n.value=e.value,n.innerText=e.name,n.selected=e.selected,e.selected&&(userInputData.theme=e),t.appendChild(n)}t.addEventListener("change",e=>{const n=themes.find(e=>e.value===t.value);if(!n)return;userInputData.theme=n;const o=loadJson(userInputSessionStoreKey,!0)||{};o.themeSelectValue=t.value,saveJson(userInputSessionStoreKey,o,!0),applyUserInputData(userInputData),renderPreview(userInputData)});const n=document.querySelector(".achievement-icon"),o=document.querySelector(".achievement-icon-select");n.addEventListener("load",e=>{userInputData.icon=n,renderPreview(userInputData)});for(const e of icons){const t=document.createElement("option");t.value=e.value,t.innerText=e.name,t.selected=e.selected,e.selected&&(n.src=e.url),o.appendChild(t)}o.addEventListener("change",e=>{const t=icons.find(e=>e.value===o.value);if(!t)return;userInputData.iconValue=o.value;const a=loadJson(userInputSessionStoreKey,!0)||{};a.iconSelectValue=o.value,saveJson(userInputSessionStoreKey,a,!0),n.src=t.url});const a=await loadImage("./img/window-mask.png");userInputData.nineSlice=new NineSlice(a,60);const r=document.querySelector(".achievement-content");r.placeholder="例: "+placeholders[Math.floor(Math.random()*placeholders.length)],r.addEventListener("input",e=>{userInputData.content=r.value;const t=loadJson(userInputSessionStoreKey,!0)||{};t.contentInputValue=r.value,saveJson(userInputSessionStoreKey,t,!0),renderPreview(userInputData)});const s=document.querySelector(".tweet-button"),i=document.querySelector(".save-button"),l=document.querySelector(".auth-button"),c=document.querySelector(".signin-button"),u=document.querySelector(".signin-cancel-button");s.addEventListener("click",t=>{!s.disabled&&e.signedIn&&(s.disabled=!0,dialogMessage.innerText="Twitterに投稿中……",dialog.dataset.visible="true",fetch(config.apigateway.post,{mode:"cors",method:"POST",headers:{"x-api-key":config.apigateway.apiKey,"Content-Type":"application/json"},body:JSON.stringify({icon:userInputData.iconValue,theme:userInputData.theme.value,content:userInputData.content,token:{key:e.oauth_token,secret:e.oauth_token_secret}})}).then(e=>{if(!e.ok)throw{status:e.status};alert("投稿に成功しました！"),saveJson(userInputSessionStoreKey,{},!0),location.reload()}).catch(e=>{console.error(e.status),alert("投稿に失敗しました")}).finally(()=>{s.disabled=!1,dialog.dataset.visible="false"}))}),i.addEventListener("click",e=>{const t=document.createElement("a");t.href=canvas.toDataURL("image/png"),t.download="achievement.png",t.click()}),c.addEventListener("click",e=>{signinDialog.dataset.visible="false",dialogMessage.innerText="Twitterと通信中……",dialog.dataset.visible="true",goToTwitterAuth().catch(e=>{dialog.dataset.visible="false",console.error(e),alert(e.message)})}),u.addEventListener("click",e=>{signinDialog.dataset.visible="false"}),e.signedIn?(l.innerText="Twitterからログアウト",l.addEventListener("click",t=>{e.signedIn&&(dialogMessage.innerText="Twitterからログアウト中……",dialog.dataset.visible="true",invalidateToken(e.oauth_token,e.oauth_token_secret).catch(e=>{dialog.dataset.visible="false",console.error(e),alert(e.message)}).finally(()=>location.reload()))})):(s.disabled=!0,l.addEventListener("click",e=>{signinDialog.dataset.visible="true"})),userInputSessionInfo&&(userInputSessionInfo.themeSelectValue&&(t.value=userInputSessionInfo.themeSelectValue,t.dispatchEvent(new Event("change"))),userInputSessionInfo.iconSelectValue&&(o.value=userInputSessionInfo.iconSelectValue,o.dispatchEvent(new Event("change"))),userInputSessionInfo.contentInputValue&&(r.value=userInputSessionInfo.contentInputValue,r.dispatchEvent(new Event("input")))),applyUserInputData(userInputData),renderPreview(userInputData)}();